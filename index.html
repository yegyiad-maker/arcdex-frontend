<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArcDEX Frontend - Bi-Directional Swap</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Ethers.js for blockchain interaction -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
    <!-- Load Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #161b22; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main DEX Container -->
    <div id="dex-app" class="w-full max-w-lg bg-[#161b22] shadow-2xl rounded-xl p-6 md:p-8">
        <h1 class="text-3xl font-extrabold text-white text-center mb-6">
            <span class="text-indigo-400">ArcDEX</span> Interface
        </h1>

        <!-- Auth Status & Network Info -->
        <div class="text-xs text-gray-400 mb-4 flex justify-between items-center">
            <div id="auth-status" class="px-2 py-1 rounded-full bg-yellow-900 text-yellow-300">
                Authenticating...
            </div>
            <div id="network-status" class="flex items-center">
                <div class="h-2 w-2 rounded-full bg-red-500 mr-2" id="rpc-dot"></div>
                <span id="account-info">Wallet Not Connected</span>
            </div>
        </div>

        <!-- Reserves and Balance Display -->
        <div id="reserve-display" class="bg-[#0d1117] p-4 rounded-lg mb-6 border border-gray-700">
            <h2 class="text-lg font-semibold text-gray-300 mb-2">Pool Reserves & Your Balances</h2>
            <p id="reserve-a" class="text-sm text-green-400">MYTA Reserve: Loading...</p>
            <p id="reserve-b" class="text-sm text-purple-400">MYTB Reserve: Loading...</p>
            <hr class="my-2 border-gray-800">
            <p id="balance-a" class="text-sm text-gray-300">Your MYTA: Loading...</p>
            <p id="balance-b" class="text-sm text-gray-300">Your MYTB: Loading...</p>
        </div>
        
        <!-- Tab Navigation -->
        <div class="flex mb-4 border-b border-gray-700">
            <button id="tab-swap" onclick="showTab('swap')" class="flex-1 py-2 text-center text-lg font-semibold border-b-2 border-indigo-500 text-white transition-colors duration-200 hover:text-indigo-400">
                Swap
            </button>
            <button id="tab-liquidity" onclick="showTab('liquidity')" class="flex-1 py-2 text-center text-lg font-semibold border-b-2 border-transparent text-gray-500 transition-colors duration-200 hover:text-purple-400">
                Liquidity
            </button>
        </div>

        <!-- SWAP CARD -->
        <div id="swap-card" class="bg-[#0d1117] p-5 rounded-lg border border-indigo-700/50">
            <div class="space-y-4">
                <!-- Input Token (DYNAMIC) -->
                <div class="relative bg-[#161b22] p-3 rounded-xl border border-gray-700">
                    <label id="label-input" class="block text-sm font-medium text-gray-400 mb-1">You Pay (MYTA)</label>
                    <input type="number" id="input-amount" oninput="updateOutput()" placeholder="0.0"
                           class="w-full bg-transparent text-white text-2xl font-bold focus:outline-none placeholder-gray-600 appearance-none [appearance:textfield] [&::-webkit-inner-spin-button]:m-0 [&::-webkit-outer-spin-button]:m-0"/>
                    <div id="symbol-input" class="absolute right-3 top-3 px-3 py-1 bg-indigo-900/50 text-indigo-300 font-semibold rounded-lg">
                        MYTA
                    </div>
                </div>

                <!-- Swap Direction Icon + FLIP Button -->
                <div class="flex justify-center -my-2 z-10">
                    <button onclick="flipTokens()" title="Flip tokens" 
                            class="p-2 bg-gray-700 border-4 border-[#0d1117] rounded-full text-white shadow-lg transition-transform hover:rotate-180 hover:bg-indigo-500">
                        <!-- Icon for flip/swap -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L11 6.414V14a1 1 0 11-2 0V6.414L7.707 8.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <!-- Output Token (DYNAMIC) -->
                <div class="relative bg-[#161b22] p-3 rounded-xl border border-gray-700">
                    <label id="label-output" class="block text-sm font-medium text-gray-400 mb-1">You Receive (MYTB)</label>
                    <input type="text" id="output-amount" placeholder="0.0" readonly
                           class="w-full bg-transparent text-white text-2xl font-bold focus:outline-none placeholder-gray-600 appearance-none [appearance:textfield] [&::-webkit-inner-spin-button]:m-0 [&::-webkit-outer-spin-button]:m-0"/>
                    <div id="symbol-output" class="absolute right-3 top-3 px-3 py-1 bg-purple-900/50 text-purple-300 font-semibold rounded-lg">
                        MYTB
                    </div>
                </div>
            </div>

            <!-- Price Impact & Fee -->
            <div class="text-xs text-gray-500 mt-4 space-y-1">
                <div class="flex justify-between">
                    <span>Price Impact:</span>
                    <span id="price-impact" class="text-red-400">--</span>
                </div>
                <div class="flex justify-between">
                    <span id="fee-label">Trade Fee (0.3% MYTA):</span>
                    <span id="trade-fee" class="text-gray-300">--</span>
                </div>
            </div>

            <!-- Action Button for Swap -->
            <button id="swap-button" onclick="handleSwap()"
                    class="w-full mt-6 py-3 px-4 rounded-xl text-lg font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 disabled:bg-gray-600"
                    disabled>
                Loading...
            </button>
        </div>
        
        <!-- LIQUIDITY CARD -->
        <div id="liquidity-card" class="bg-[#0d1117] p-5 rounded-lg border border-purple-700/50 hidden">
            <h2 class="text-xl font-bold text-white mb-4">Add Liquidity</h2>
            <div class="space-y-4">
                <!-- Input Token A -->
                <div class="relative bg-[#161b22] p-3 rounded-xl border border-gray-700">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Amount MYTA</label>
                    <input type="number" id="input-amount-a" oninput="updateLiquidityRatio('A')" placeholder="0.0"
                           class="w-full bg-transparent text-white text-2xl font-bold focus:outline-none placeholder-gray-600 appearance-none [appearance:textfield] [&::-webkit-inner-spin-button]:m-0 [&::-webkit-outer-spin-button]:m-0"/>
                    <div class="absolute right-3 top-3 px-3 py-1 bg-indigo-900/50 text-indigo-300 font-semibold rounded-lg">
                        MYTA
                    </div>
                </div>

                <!-- Input Token B -->
                <div class="relative bg-[#161b22] p-3 rounded-xl border border-gray-700">
                    <label class="block text-sm font-medium text-gray-400 mb-1">Amount MYTB</label>
                    <input type="number" id="input-amount-b" oninput="updateLiquidityRatio('B')" placeholder="0.0"
                           class="w-full bg-transparent text-white text-2xl font-bold focus:outline-none placeholder-gray-600 appearance-none [appearance:textfield] [&::-webkit-inner-spin-button]:m-0 [&::-webkit-outer-spin-button]:m-0"/>
                    <div class="absolute right-3 top-3 px-3 py-1 bg-purple-900/50 text-purple-300 font-semibold rounded-lg">
                        MYTB
                    </div>
                </div>
            </div>

            <p id="liquidity-note" class="text-xs text-gray-500 mt-4">
                Note: For initial liquidity, both amounts must be greater than zero. Subsequent deposits must match the current pool ratio.
            </p>

            <!-- Action Button for Liquidity -->
            <button id="add-liquidity-button" onclick="handleAddLiquidity()"
                    class="w-full mt-6 py-3 px-4 rounded-xl text-lg font-bold text-white bg-purple-600 hover:bg-purple-700 transition-colors duration-200 disabled:bg-gray-600"
                    disabled>
                Add Liquidity
            </button>
        </div>

        <!-- Error/Message Box -->
        <div id="message-box" class="mt-4 p-3 hidden rounded-lg text-sm" role="alert"></div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth;
        let isAuthReady = false;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            window.db = db; // Attach to window for global access if needed
            window.auth = auth;

            // Auth Listener
            onAuthStateChanged(auth, async (user) => {
                const authStatusEl = document.getElementById('auth-status');
                if (user) {
                    authStatusEl.textContent = `User ID: ${user.uid.substring(0, 8)}...`;
                    authStatusEl.className = 'px-2 py-1 rounded-full bg-green-900 text-green-300 text-xs';
                    isAuthReady = true;
                    // Proceed to Ethers setup once authenticated
                    setupEthers();
                } else {
                    authStatusEl.textContent = 'Not Signed In';
                    authStatusEl.className = 'px-2 py-1 rounded-full bg-red-900 text-red-300 text-xs';
                }
            });

            // Sign in immediately using the custom token or anonymously
            async function authenticateUser() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    document.getElementById('auth-status').textContent = 'Auth Failed';
                }
            }
            authenticateUser();

        } else {
            document.getElementById('auth-status').textContent = 'Firebase Config Missing';
            // If config is missing, proceed directly to Ethers setup
            setupEthers();
        }

    </script>

    <!-- DEX Logic -->
    <script>
        // --- ðŸ›‘ UPDATE THESE ADDRESSES AFTER YOU RE-DEPLOY ðŸ›‘ ---
        // These are the OLD addresses that are NOT WORKING.
        // You MUST replace these with the new addresses from your 'DeployArcDEX.s.sol' output.
        const DEX_POOL_ADDRESS = "0x175d2B9b3481A44C30baBA9ABeed9B9e2A9954b6"; 
        const MY_TOKEN_A_ADDRESS = "0x32268eA834d5e7afAc9e1492fdAA77b99C6DDe67";   
        const MY_TOKEN_B_ADDRESS = "0x7B3F6713f752f48F37076081432810E0f1C89268";   
        // ----------------------------------------------------

        // Token Configuration Map
        const TOKEN_INFO = {
            MYTA: { 
                address: MY_TOKEN_A_ADDRESS, 
                symbol: "MYTA", 
                reserveKey: "reserve0", // Will be set dynamically
                balanceId: "balance-a", 
                contractKey: "mytaContract",
                inputColor: 'indigo'
            },
            MYTB: { 
                address: MY_TOKEN_B_ADDRESS, 
                symbol: "MYTB", 
                reserveKey: "reserve1", // Will be set dynamically
                balanceId: "balance-b", 
                contractKey: "mytbContract",
                inputColor: 'purple'
            }
        };

        // Standard ERC-20 ABI
        const ERC20_ABI = [
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function transferFrom(address sender, address recipient, uint256 amount) returns (bool)",
            "function balanceOf(address account) view returns (uint256)",
            "function symbol() view returns (string)"
        ];

        // --- CRITICAL FIX: Updated DEX ABI ---
        // The addLiquidity function signature has changed
        const DEX_ABI = [
            "function reserve0() view returns (uint256)",
            "function reserve1() view returns (uint256)",
            "function TOKEN_0() view returns (address)",
            "function TOKEN_1() view returns (address)",
            "function swap(address _tokenIn, uint256 _amountIn)",
            // New signature for addLiquidity
            "function addLiquidity(address tokenA, address tokenB, uint256 amountADesired, uint256 amountBDesired) returns (uint256 amount0, uint256 amount1)"
        ];

        // Global state
        let state = {
            provider: null,
            signer: null,
            dexContract: null,
            mytaContract: null,
            mytbContract: null,
            reserve0: 0n, // Use BigInts for reserve math
            reserve1: 0n,
            isPoolReady: false,
            currentTab: 'swap',
            tokenInKey: 'MYTA', // Default input token is MYTA
            tokenOutKey: 'MYTB', // Default output token is MYTB
            token0Address: '', // Store the sorted token 0 address
            token1Address: '', // Store the sorted token 1 address
        };

        // UI elements
        const swapButton = document.getElementById('swap-button');
        const liquidityButton = document.getElementById('add-liquidity-button');
        const inputAmountEl = document.getElementById('input-amount');
        const outputAmountEl = document.getElementById('output-amount');
        const inputAmountAEl = document.getElementById('input-amount-a');
        const inputAmountBEl = document.getElementById('input-amount-b');
        const rpcDot = document.getElementById('rpc-dot');
        const accountInfoEl = document.getElementById('account-info');
        const msgBox = document.getElementById('message-box');

        // Make functions globally accessible for onclick handlers
        window.showTab = showTab;
        window.flipTokens = flipTokens;
        window.updateOutput = updateOutput;
        window.handleSwap = handleSwap;
        window.handleAddLiquidity = handleAddLiquidity;
        window.updateLiquidityRatio = updateLiquidityRatio;

        /**
         * Switches the active tab (Swap or Liquidity).
         */
        function showTab(tabName) {
            state.currentTab = tabName;
            document.getElementById('swap-card').classList.toggle('hidden', tabName !== 'swap');
            document.getElementById('liquidity-card').classList.toggle('hidden', tabName !== 'liquidity');

            document.getElementById('tab-swap').classList.toggle('border-indigo-500', tabName === 'swap');
            document.getElementById('tab-swap').classList.toggle('text-white', tabName === 'swap');
            document.getElementById('tab-swap').classList.toggle('border-transparent', tabName !== 'swap');
            document.getElementById('tab-swap').classList.toggle('text-gray-500', tabName !== 'swap');

            document.getElementById('tab-liquidity').classList.toggle('border-purple-500', tabName === 'liquidity');
            document.getElementById('tab-liquidity').classList.toggle('text-white', tabName === 'liquidity');
            document.getElementById('tab-liquidity').classList.toggle('border-transparent', tabName !== 'liquidity');
            document.getElementById('tab-liquidity').classList.toggle('text-gray-500', tabName !== 'liquidity');
        }

        /**
         * Utility to display messages/errors in the dedicated box.
         */
        function displayMessage(message, type = 'info') {
            msgBox.textContent = message;
            msgBox.classList.remove('hidden', 'bg-red-900', 'bg-green-900', 'bg-blue-9CO0', 'text-red-300', 'text-green-300', 'text-blue-300');
            
            if (type === 'error') {
                msgBox.classList.add('bg-red-900', 'text-red-300');
            } else if (type === 'success') {
                msgBox.classList.add('bg-green-900', 'text-green-300');
            } else {
                msgBox.classList.add('bg-blue-900', 'text-blue-300');
            }
        }

        /**
         * Converts BigInt or string balance (in smallest unit) to a readable fixed-point number.
         */
        function formatUnits(amount, decimals = 18) {
            try {
                return ethers.formatUnits(amount, decimals);
            } catch (e) {
                return "0.0";
            }
        }

        /**
         * Converts a user-input string (e.g., "1.5") to a BigInt in its smallest unit.
         */
        function parseUnits(amount, decimals = 18) {
            try {
                if (!amount || isNaN(parseFloat(amount))) {
                    return 0n;
                }
                return ethers.parseUnits(amount, decimals);
            } catch (e) {
                return 0n;
            }
        }

        /**
         * Sets up Ethers provider, signer, and contract instances.
         */
        async function setupEthers() {
            try {
                if (!window.ethereum) {
                    throw new Error("MetaMask or similar provider not detected.");
                }
                
                // FIX: Request accounts to force connection prompt and unblock signer
                state.provider = new ethers.BrowserProvider(window.ethereum);
                await state.provider.send('eth_requestAccounts', []);
                
                state.signer = await state.provider.getSigner();
                const address = await state.signer.getAddress();
                accountInfoEl.textContent = `Account: ${address.substring(0, 6)}...`;
                rpcDot.classList.replace('bg-red-500', 'bg-green-500');

                // Setup Contracts
                state.dexContract = new ethers.Contract(DEX_POOL_ADDRESS, DEX_ABI, state.signer);
                state.mytaContract = new ethers.Contract(MY_TOKEN_A_ADDRESS, ERC20_ABI, state.signer);
                state.mytbContract = new ethers.Contract(MY_TOKEN_B_ADDRESS, ERC20_ABI, state.signer);
                
                // Get sorted token addresses from the pool
                state.token0Address = await state.dexContract.TOKEN_0();
                state.token1Address = await state.dexContract.TOKEN_1();

                // Dynamically assign which reserve (0 or 1) belongs to which token (MYTA or MYTB)
                if (TOKEN_INFO.MYTA.address.toLowerCase() === state.token0Address.toLowerCase()) {
                    TOKEN_INFO.MYTA.reserveKey = "reserve0";
                    TOKEN_INFO.MYTB.reserveKey = "reserve1";
                } else {
                    TOKEN_INFO.MYTA.reserveKey = "reserve1";
                    TOKEN_INFO.MYTB.reserveKey = "reserve0";
                }
                
                await getReservesAndBalances();
                
            } catch (error) {
                console.error("Ethers Setup Error:", error);
                let readableError = error.message.length > 100 ? error.message.substring(0, 100) + "..." : error.message;
                displayMessage(`Connection failed. Ensure you are on the correct network (Arc Testnet). Error: ${readableError}`, 'error');
                swapButton.textContent = "Connection Error";
                swapButton.disabled = true;
                liquidityButton.textContent = "Connection Error";
                liquidityButton.disabled = true;
            }
        }
        
        /**
         * Fetches and displays the current reserves from the DEX pool.
         */
        async function getReservesAndBalances() {
            try {
                const [reserve0, reserve1, balanceA, balanceB] = await Promise.all([
                    state.dexContract.reserve0(),
                    state.dexContract.reserve1(),
                    state.mytaContract.balanceOf(await state.signer.getAddress()),
                    state.mytbContract.balanceOf(await state.signer.getAddress())
                ]);

                // Store reserves based on sorted order
                state.reserve0 = reserve0;
                state.reserve1 = reserve1;

                // Update UI for reserves based on which token is 0 or 1
                document.getElementById(TOKEN_INFO.MYTA.reserveId.replace('reserve', 'reserve-')).textContent = `MYTA Reserve: ${formatUnits(state[TOKEN_INFO.MYTA.reserveKey])}`;
                document.getElementById(TOKEN_INFO.MYTB.reserveId.replace('reserve', 'reserve-')).textContent = `MYTB Reserve: ${formatUnits(state[TOKEN_INFO.MYTB.reserveKey])}`;
                
                // Update UI for balances
                document.getElementById('balance-a').textContent = `Your MYTA: ${formatUnits(balanceA)}`;
                document.getElementById('balance-b').textContent = `Your MYTB: ${formatUnits(balanceB)}`;

                state.isPoolReady = state.reserve0 > 0n && state.reserve1 > 0n;

                if (state.isPoolReady) {
                    swapButton.textContent = "Swap";
                    swapButton.disabled = false;
                    liquidityButton.textContent = "Add Liquidity";
                    liquidityButton.disabled = false;
                } else {
                    swapButton.textContent = "Pool has no liquidity";
                    swapButton.disabled = true;
                    liquidityButton.textContent = "Add Initial Liquidity";
                    liquidityButton.disabled = false; // Allow initial liquidity
                }
            } catch (error) {
                console.error("Error fetching reserves or balances:", error);
                displayMessage("Could not fetch pool reserves or balances. Check contract addresses and network connection.", 'error');
                swapButton.textContent = "Error Loading";
                swapButton.disabled = true;
                liquidityButton.textContent = "Error Loading";
                liquidityButton.disabled = true;
            }
        }
        
        /**
         * Flips the tokenIn and tokenOut for swapping.
         */
        function flipTokens() {
            [state.tokenInKey, state.tokenOutKey] = [state.tokenOutKey, state.tokenInKey];
            
            const tokenIn = TOKEN_INFO[state.tokenInKey];
            const tokenOut = TOKEN_INFO[state.tokenOutKey];

            // Update labels
            document.getElementById('label-input').textContent = `You Pay (${tokenIn.symbol})`;
            document.getElementById('label-output').textContent = `You Receive (${tokenOut.symbol})`;
            document.getElementById('fee-label').textContent = `Trade Fee (0.3% ${tokenIn.symbol}):`;

            // Update symbols and colors
            const symbolInEl = document.getElementById('symbol-input');
            symbolInEl.textContent = tokenIn.symbol;
            symbolInEl.className = `absolute right-3 top-3 px-3 py-1 bg-${tokenIn.inputColor}-900/50 text-${tokenIn.inputColor}-300 font-semibold rounded-lg`;

            const symbolOutEl = document.getElementById('symbol-output');
            symbolOutEl.textContent = tokenOut.symbol;
            symbolOutEl.className = `absolute right-3 top-3 px-3 py-1 bg-${tokenOut.inputColor}-900/50 text-${tokenOut.inputColor}-300 font-semibold rounded-lg`;

            // Recalculate output
            updateOutput();
        }

        /**
         * Calculates the output amount using the Constant Product Market Maker formula.
         */
        function getAmountOut(amountIn, reserveIn, reserveOut) {
            if (amountIn <= 0n || reserveIn <= 0n || reserveOut <= 0n) {
                return 0n;
            }
            const amountInWithFee = amountIn * 997n; // 0.3% fee
            const numerator = amountInWithFee * reserveOut;
            const denominator = (reserveIn * 1000n) + amountInWithFee;
            return numerator / denominator;
        }

        /**
         * Handles real-time input and updates the estimated output.
         */
        function updateOutput() {
            if (!state.isPoolReady) return;

            try {
                const tokenIn = TOKEN_INFO[state.tokenInKey];
                const tokenOut = TOKEN_INFO[state.tokenOutKey];

                const reserveIn = state[tokenIn.reserveKey];
                const reserveOut = state[tokenOut.reserveKey];

                const inputVal = inputAmountEl.value;
                const amountIn = parseUnits(inputVal);

                if (amountIn === 0n) {
                    outputAmountEl.value = '0.0';
                    document.getElementById('price-impact').textContent = '--';
                    document.getElementById('trade-fee').textContent = '--';
                    return;
                }
                
                const amountOut = getAmountOut(amountIn, reserveIn, reserveOut);
                outputAmountEl.value = formatUnits(amountOut);

                // Calculate Price Impact
                const newReserveIn = reserveIn + amountIn;
                const newReserveOut = reserveOut - amountOut;
                // (newPrice - midPrice) / midPrice
                const midPrice = (reserveIn * 1000000n) / reserveOut;
                const newPrice = (newReserveIn * 1000000n) / newReserveOut;
                const impact = ((newPrice - midPrice) * 10000n) / midPrice;
                document.getElementById('price-impact').textContent = `${formatUnits(impact, 4)}%`;

                // Calculate Fee
                const fee = (amountIn * 3n) / 1000n; // 0.3%
                document.getElementById('trade-fee').textContent = `${formatUnits(fee, 18)} ${tokenIn.symbol}`;

            } catch (error) {
                console.error("Calculation Error:", error);
                outputAmountEl.value = 'Error';
            }
        }

        /**
         * Calculates the required amount of Token B given Token A for liquidity.
         */
        function updateLiquidityRatio(anchor) {
            if (!state.isPoolReady) return; // Only apply ratio if pool is ready

            try {
                const reserveA = state[TOKEN_INFO.MYTA.reserveKey];
                const reserveB = state[TOKEN_INFO.MYTB.reserveKey];

                if (anchor === 'A') {
                    const amountA = parseUnits(inputAmountAEl.value);
                    const amountB = (amountA * reserveB) / reserveA;
                    inputAmountBEl.value = formatUnits(amountB);
                } else if (anchor === 'B') {
                    const amountB = parseUnits(inputAmountBEl.value);
                    const amountA = (amountB * reserveA) / reserveB;
                    inputAmountAEl.value = formatUnits(amountA);
                }
            } catch (e) {
                // Handle division by zero if reserves are 0
                if (anchor === 'A') inputAmountBEl.value = '';
                if (anchor === 'B') inputAmountAEl.value = '';
            }
        }

        /**
         * Executes the approve and swap transactions.
         */
        async function handleSwap() {
            if (!state.isPoolReady || !state.signer) {
                displayMessage("Wallet not connected or pool not ready.", 'error');
                return;
            }

            const tokenInInfo = TOKEN_INFO[state.tokenInKey];
            const tokenInContract = state[tokenInInfo.contractKey];
            const amountIn = parseUnits(inputAmountEl.value);

            if (amountIn === 0n) {
                displayMessage("Cannot swap 0 tokens.", 'error');
                return;
            }

            swapButton.textContent = "Processing...";
            swapButton.disabled = true;
            displayMessage("Please approve the token spend in your wallet...", 'info');

            try {
                // 1. Approve
                const approveTx = await tokenInContract.approve(DEX_POOL_ADDRESS, amountIn);
                await approveTx.wait();
                displayMessage("Approval successful! Now confirm the swap...", 'info');

                // 2. Swap
                const swapTx = await state.dexContract.swap(tokenInInfo.address, amountIn);
                await swapTx.wait();
                
                displayMessage("Swap successful!", 'success');
                await getReservesAndBalances(); // Refresh state
                inputAmountEl.value = '';
                outputAmountEl.value = '';

            } catch (error) {
                console.error("Swap Error:", error);
                displayMessage(`Swap failed: ${error.reason || error.message}`, 'error');
            } finally {
                swapButton.textContent = "Swap";
                swapButton.disabled = false;
            }
        }
        
        /**
         * --- CRITICAL FIX: Executes the new addLiquidity transaction ---
         */
        async function handleAddLiquidity() {
            if (!state.signer) {
                displayMessage("Wallet not connected.", 'error');
                return;
            }
            
            const amountADesired = parseUnits(inputAmountAEl.value);
            const amountBDesired = parseUnits(inputAmountBEl.value);

            if (amountADesired === 0n || amountBDesired === 0n) {
                displayMessage("Both amounts must be greater than zero.", 'error');
                return;
            }

            liquidityButton.textContent = "Processing...";
            liquidityButton.disabled = true;
            displayMessage("Please approve MYTA spend in your wallet...", 'info');

            try {
                // 1. Approve MYTA
                const approveATx = await state.mytaContract.approve(DEX_POOL_ADDRESS, amountADesired);
                await approveATx.wait();
                displayMessage("MYTA approved! Please approve MYTB spend...", 'info');

                // 2. Approve MYTB
                const approveBTx = await state.mytbContract.approve(DEX_POOL_ADDRESS, amountBDesired);
                await approveBTx.wait();
                displayMessage("MYTB approved! Now confirm adding liquidity...", 'info');
                
                // 3. Add Liquidity
                // Call the new, robust addLiquidity function with 4 arguments
                const liquidityTx = await state.dexContract.addLiquidity(
                    MY_TOKEN_A_ADDRESS,
                    MY_TOKEN_B_ADDRESS,
                    amountADesired,
                    amountBDesired
                );
                await liquidityTx.wait();
                
                displayMessage("Liquidity added successfully!", 'success');
                await getReservesAndBalances(); // Refresh state
                inputAmountAEl.value = '';
                inputAmountBEl.value = '';

            } catch (error) {
                console.error("Add Liquidity Error:", error);
                displayMessage(`Failed to add liquidity: ${error.reason || "transaction reverted"}`, 'error');
            } finally {
                liquidityButton.textContent = "Add Liquidity";
                liquidityButton.disabled = false;
            }
        }


        // Initialize Ethers on window load
        window.onload = function() {
            if (!firebaseConfig) {
                 // setupEthers(); // Already called in the non-config branch
            }
            // Set up interval to refresh reserves every 30 seconds
            setInterval(getReservesAndBalances, 30000);
        };
    </script>

</body>
</html>