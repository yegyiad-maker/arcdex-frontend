<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ArcDEX Multi-Pool</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <style>
        /* ... (CSS styles omitted for brevity, identical to previous) ... */
        body { font-family: Arial, sans-serif; background-color: #f4f7f6; color: #333; }
        .container { max-width: 600px; margin: 40px auto; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); background-color: #fff; }
        h1 { color: #007bff; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .section { margin-bottom: 25px; padding: 20px; border: 1px dashed #ced4da; border-radius: 8px; background-color: #f8f9fa; }
        input, select, button { padding: 12px; margin: 8px 0; width: 100%; box-sizing: border-box; border-radius: 6px; border: 1px solid #ced4da; }
        button { background-color: #007bff; color: white; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        #message { margin-top: 20px; padding: 15px; border-radius: 6px; font-weight: bold; }
        .status-info { margin-bottom: 15px; font-size: 0.9em; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ArcDEX Multi-Pool</h1>
        <div class="status-info">
            <p>Wallet Status: <span id="walletStatus">Not Connected</span></p>
            <p>Active Pool: <span id="poolAddressDisplay">None Selected</span></p>
            <p id="poolReserves">Current Reserves: N/A</p>
        </div>
        
        <div id="message"></div>

        <div class="section">
            <h2>üíß Add Liquidity</h2>
            <select id="liqTokenA">
                <option value="USDC">USDC</option>
                <option value="MYTA">MYTA</option>
                <option value="MYTB">MYTB</option>
            </select>
            <input type="number" id="liqAmountA" placeholder="Amount A">
            
            <select id="liqTokenB">
                <option value="MYTA">MYTA</option>
                <option value="MYTB">MYTB</option>
                <option value="USDC">USDC</option>
            </select>
            <input type="number" id="liqAmountB" placeholder="Amount B">
            
            <button onclick="handleAddLiquidity()">Add Liquidity</button>
        </div>

        <div class="section">
            <h2>‚ÜîÔ∏è Token Swap</h2>
            <select id="swapTokenIn" onchange="getReservesAndBalances()">
                <option value="USDC">USDC</option>
                <option value="MYTA">MYTA</option>
                <option value="MYTB">MYTB</option>
            </select>
            <input type="number" id="swapAmountIn" placeholder="Amount In">
            <select id="swapTokenOut" onchange="getReservesAndBalances()">
                <option value="MYTA">MYTA</option>
                <option value="MYTB">MYTB</option>
                <option value="USDC">USDC</option>
            </select>
            <button onclick="handleSwap()">Swap Tokens</button>
        </div>
    </div>

    <script>
        // --- CONSTANTS AND CONFIGURATION ---
        
        // üõë CRITICAL: REPLACE THESE PLACEHOLDERS WITH YOUR DEPLOYED ADDRESSES
        const ARC_USDC_ADDRESS = "0x3600000000000000000000000000000000000000"; // Fixed Arc Testnet USDC
        const MYTA_ADDRESS = "0xa654C7Ef6Ba495A77550D629f2b05bEF3e15c588"; 
        const MYTB_ADDRESS = "0xECE33627200cA2430058EFFe099112852C65A5D6"; 
        const USDC_MYTA_POOL = "0x17b8CB279403798Af128F09093c40BAfD72FAe77";
        const USDC_MYTB_POOL = "0x3727df20d3a36440076c671159a2DC99652fE301";
        const MYTA_MYTB_POOL = "0xf15C905d07Af533B9300d55277331009377A9dB1";
        
        // Token Symbol to Address Mapping
        const tokenNameToAddress = {
            "USDC": ARC_USDC_ADDRESS,
            "MYTA": MYTA_ADDRESS,
            "MYTB": MYTB_ADDRESS,
        };

        // Pool Address Mapping (Key is tokens sorted alphabetically for consistency)
        const poolAddressMap = {
            "MYTA/USDC": USDC_MYTA_POOL,
            "MYTB/USDC": USDC_MYTB_POOL, 
            "MYTA/MYTB": MYTA_MYTB_POOL,
        };
        
        // ABI definitions (partial)
        const POOL_ABI = [
            { "constant": true, "inputs": [], "name": "getReserves", "outputs": [{ "name": "reserveA", "type": "uint256" }, { "name": "reserveB", "type": "uint256" }], "type": "function" },
            { "constant": false, "inputs": [{ "name": "tokenA", "type": "address" }, { "name": "tokenB", "type": "address" }, { "name": "amountADesired", "type": "uint256" }, { "name": "amountBDesired", "type": "uint256" }], "name": "addLiquidity", "outputs": [{ "name": "amount0", "type": "uint256" }, { "name": "amount1", "type": "uint256" }], "type": "function" },
            { "constant": false, "inputs": [{ "name": "tokenIn", "type": "address" }, { "name": "amountIn", "type": "uint256" }], "name": "swap", "outputs": [], "type": "function" }
        ];

        const ERC20_ABI = [
            { "constant": false, "inputs": [{ "name": "spender", "type": "address" }, { "name": "amount", "type": "uint256" }], "name": "approve", "outputs": [{ "name": "", "type": "bool" }], "type": "function" },
            { "constant": true, "inputs": [{ "name": "owner", "type": "address" }], "name": "balanceOf", "outputs": [{ "name": "", "type": "uint256" }], "type": "function" }
        ];

        // Global variables
        let web3;
        let accounts;
        
        // --- UTILITY FUNCTIONS ---

        function displayMessage(text, isError = false) {
            const msgElement = document.getElementById('message');
            msgElement.textContent = text;
            msgElement.style.borderColor = isError ? 'red' : 'green';
            msgElement.style.color = isError ? 'red' : 'green';
        }

        /**
         * @notice Determines the correct pool address based on the two token symbols.
         */
        function getPoolContract(tokenA, tokenB) {
            // Ensure the tokens are sorted alphabetically to form a consistent key
            const sortedSymbols = [tokenA, tokenB].sort();
            const poolKey = `${sortedSymbols[0]}/${sortedSymbols[1]}`;
            
            const poolAddress = poolAddressMap[poolKey];

            if (!poolAddress || poolAddress.includes("PASTE_")) {
                document.getElementById('poolAddressDisplay').textContent = "ERROR: Pool not configured for this pair!";
                return null;
            }
            
            document.getElementById('poolAddressDisplay').textContent = `Active Pool: ${poolKey} (${poolAddress.substring(0, 6)}...)`;
            
            return new web3.eth.Contract(POOL_ABI, poolAddress);
        }

        async function getReservesAndBalances() {
            const tokenInSymbol = document.getElementById('swapTokenIn').value;
            const tokenOutSymbol = document.getElementById('swapTokenOut').value;
            
            if (tokenInSymbol === tokenOutSymbol) {
                document.getElementById('poolReserves').textContent = 'Select two different tokens.';
                return;
            }
            
            const poolContract = getPoolContract(tokenInSymbol, tokenOutSymbol);
            if (!poolContract) return;

            try {
                // Get Pool Reserves
                const result = await poolContract.methods.getReserves().call();
                
                const reserveA = web3.utils.fromWei(result.reserveA);
                const reserveB = web3.utils.fromWei(result.reserveB);
                
                document.getElementById('poolReserves').textContent = 
                    `Reserves (A/B order): ${parseFloat(reserveA).toFixed(2)}, ${parseFloat(reserveB).toFixed(2)}`;

            } catch (error) {
                console.error("Error fetching reserves:", error);
                document.getElementById('poolReserves').textContent = 'Error fetching reserves (Is pool deployed?).';
            }
        }

        async function approveToken(tokenAddress, amount, spenderAddress) {
            const tokenContract = new web3.eth.Contract(ERC20_ABI, tokenAddress);
            const amountWei = web3.utils.toWei(amount.toString(), 'ether');

            displayMessage(`Approving ${amount} on ${tokenAddress}...`);

            await tokenContract.methods.approve(spenderAddress, amountWei)
                .send({ from: accounts[0] })
                .on('transactionHash', function(hash){
                    displayMessage(`Approval transaction sent: ${hash.substring(0, 10)}...`);
                });
        }


        // --- MAIN APPLICATION LOGIC ---

        async function initWeb3() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    document.getElementById('walletStatus').textContent = `Connected: ${accounts[0].substring(0, 6)}...`;
                    
                    getReservesAndBalances();
                    // Poll for updates on reserves
                    setInterval(getReservesAndBalances, 5000); 
                } catch (error) {
                    displayMessage("Wallet connection failed.", true);
                }
            } else {
                displayMessage("Please install MetaMask!", true);
            }
        }

        async function handleAddLiquidity() {
            const tokenASymbol = document.getElementById('liqTokenA').value;
            const tokenBSymbol = document.getElementById('liqTokenB').value;
            const amountA = document.getElementById('liqAmountA').value;
            const amountB = document.getElementById('liqAmountB').value;
            
            if (tokenASymbol === tokenBSymbol) return displayMessage("Tokens must be different.", true);
            if (!amountA || !amountB || amountA <= 0 || amountB <= 0) return displayMessage("Enter valid amounts.", true);
            
            const poolContract = getPoolContract(tokenASymbol, tokenBSymbol);
            if (!poolContract) return;

            const poolAddress = poolContract._address;
            const tokenAAddress = tokenNameToAddress[tokenASymbol];
            const tokenBAddress = tokenNameToAddress[tokenBSymbol];
            const amountAWei = web3.utils.toWei(amountA, 'ether');
            const amountBWei = web3.utils.toWei(amountB, 'ether');

            try {
                // 1. Approve Token A to the specific pool
                await approveToken(tokenAAddress, amountA, poolAddress);
                // 2. Approve Token B to the specific pool
                await approveToken(tokenBAddress, amountB, poolAddress);

                // 3. Add Liquidity
                displayMessage("Sending Add Liquidity transaction...");
                await poolContract.methods.addLiquidity(tokenAAddress, tokenBAddress, amountAWei, amountBWei)
                    .send({ from: accounts[0] })
                    .on('receipt', function(receipt){
                        displayMessage(`Liquidity added successfully! Tx: ${receipt.transactionHash.substring(0, 10)}...`);
                        getReservesAndBalances();
                    });

            } catch (error) {
                console.error("Add Liquidity failed:", error);
                displayMessage("Add Liquidity failed. Check console for details.", true);
            }
        }

        async function handleSwap() {
            const tokenInSymbol = document.getElementById('swapTokenIn').value;
            const tokenOutSymbol = document.getElementById('swapTokenOut').value;
            const amountIn = document.getElementById('swapAmountIn').value;
            
            if (tokenInSymbol === tokenOutSymbol) return displayMessage("Tokens must be different.", true);
            if (!amountIn || amountIn <= 0) return displayMessage("Enter a valid amount to swap.", true);
            
            const poolContract = getPoolContract(tokenInSymbol, tokenOutSymbol);
            if (!poolContract) return;

            const poolAddress = poolContract._address;
            const tokenInAddress = tokenNameToAddress[tokenInSymbol];
            const amountInWei = web3.utils.toWei(amountIn, 'ether');

            try {
                // 1. Approve Token In to the specific pool
                await approveToken(tokenInAddress, amountIn, poolAddress);

                // 2. Perform Swap
                displayMessage("Sending Swap transaction...");
                await poolContract.methods.swap(tokenInAddress, amountInWei)
                    .send({ from: accounts[0] })
                    .on('receipt', function(receipt){
                        displayMessage(`Swap successful! Check reserves. Tx: ${receipt.transactionHash.substring(0, 10)}...`);
                        getReservesAndBalances();
                    });

            } catch (error) {
                console.error("Swap failed:", error);
                displayMessage("Swap failed. Check console for details.", true);
            }
        }

        window.addEventListener('load', initWeb3);

    </script>

</body>
</html>